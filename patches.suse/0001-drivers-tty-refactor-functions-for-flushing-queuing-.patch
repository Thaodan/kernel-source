From: Steven Walter <stevenrwalter@gmail.com>
Date: Thu, 10 Jan 2019 11:12:30 +0100
Subject: [PATCH 1/3] drivers/tty: refactor functions for flushing/queuing work
Patch-mainline: Not yet, EB-only
References: bsc#1191701

Preparation for converting to kthread_worker

Signed-off-by: Steven Walter <stevenrwalter@gmail.com>
Tested-by: Oleksij Rempel <o.rempel@pengutronix.de>
Link: https://lore.kernel.org/lkml/20190110101232.9398-2-o.rempel@pengutronix.de/
Acked-by: Varad Gautam <varad.gautam@suse.com>

---
 drivers/tty/tty_buffer.c |   14 ++++++++++----
 include/linux/tty.h      |    1 +
 2 files changed, 11 insertions(+), 4 deletions(-)

--- a/drivers/tty/tty_buffer.c
+++ b/drivers/tty/tty_buffer.c
@@ -72,7 +72,7 @@ void tty_buffer_unlock_exclusive(struct
 	atomic_dec(&buf->priority);
 	mutex_unlock(&buf->lock);
 	if (restart)
-		queue_work(system_unbound_wq, &buf->work);
+		tty_buffer_queue_work(port);
 }
 EXPORT_SYMBOL_GPL(tty_buffer_unlock_exclusive);
 
@@ -416,7 +416,7 @@ void tty_schedule_flip(struct tty_port *
 	struct tty_bufhead *buf = &port->buf;
 
 	tty_flip_buffer_commit(buf->tail);
-	queue_work(system_unbound_wq, &buf->work);
+	tty_buffer_queue_work(port);
 }
 EXPORT_SYMBOL(tty_schedule_flip);
 
@@ -549,6 +549,12 @@ static void flush_to_ldisc(struct work_s
 
 }
 
+bool tty_buffer_queue_work(struct tty_port *port)
+{
+	struct tty_bufhead *buf = &port->buf;
+	return schedule_work(&buf->work);
+}
+
 /**
  *	tty_flip_buffer_push	-	terminal
  *	@port: tty port to push
@@ -592,7 +598,7 @@ int tty_insert_flip_string_and_push_buff
 		tty_flip_buffer_commit(buf->tail);
 	spin_unlock_irqrestore(&port->lock, flags);
 
-	queue_work(system_unbound_wq, &buf->work);
+	tty_buffer_queue_work(port);
 
 	return size;
 }
@@ -645,7 +651,7 @@ void tty_buffer_set_lock_subclass(struct
 
 bool tty_buffer_restart_work(struct tty_port *port)
 {
-	return queue_work(system_unbound_wq, &port->buf.work);
+	return tty_buffer_queue_work(port);
 }
 
 bool tty_buffer_cancel_work(struct tty_port *port)
--- a/include/linux/tty.h
+++ b/include/linux/tty.h
@@ -513,6 +513,7 @@ extern void session_clear_tty(struct pid
 extern void no_tty(void);
 extern void tty_buffer_free_all(struct tty_port *port);
 extern void tty_buffer_flush(struct tty_struct *tty, struct tty_ldisc *ld);
+extern bool tty_buffer_queue_work(struct tty_port *port);
 extern void tty_buffer_init(struct tty_port *port);
 extern void tty_buffer_set_lock_subclass(struct tty_port *port);
 extern bool tty_buffer_restart_work(struct tty_port *port);
